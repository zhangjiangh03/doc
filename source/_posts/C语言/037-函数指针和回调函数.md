---
title: 函数指针和回调函数
date: 2022-12-25 13:45:00
categories:
- C语言
tags:
- C语言基础
---

函数指针和回调函数是 C 和 C++ 语言中非常重要的两个特性。

## 概念

### 函数指针

函数指针是指向函数的指针，就像指针可以指向变量一样。

```
return_type (*name)(parameter_list);
```

- `return_type`是函数的返回类型；
- `name`是函数指针的名称；
- `parameter_list`是函数的参数列表。

```c
int add(int a, int b) {
    return a + b;
}

int (*p)(int, int) = add;
int result = p(3, 4); // result = 7
```

上面的代码中定义了一个名为`add`的函数，它将两个整数相加。然后我们定义了一个函数指针`p`来指向`add`函数，并通过指针调用该函数。

### 回调函数

回调函数是函数指针的一种应用，它是一种可供其他函数调用的函数。

```c
int add(int a, int b) {
    return a + b;
}

int sub(int a, int b) {
    return a - b;
}

int operate(int a, int b, int (*p)(int, int)) {
    return p(a, b);
}

int result1 = operate(3, 4, add); // result1 = 7
int result2 = operate(3, 4, sub); // result2 = -1
```

上面的代码中定义了两个函数`add`和`sub`，它们分别将两个整数相加和相减。
然后我们定义了一个函数`operate`，它接受两个`int`参数和一个函数指针，并通过指针调用相应的函数。
最后我们使用`operate`函数来分别调用`add`和`sub`函数，并输出结果。

## 使用场景

### 函数指针

函数指针在排序、回调函数等编程场景中非常有用。

```c
int cmp(const void *a, const void *b) {
    return *(int *)a - *(int *)b;
}

qsort(arr, n, sizeof(int), cmp);
```

上面的代码中定义了一个名为`cmp`的函数指针，它接受两个`const void *`类型参数，并返回一个整数。然后我们使用标准库函数`qsort`来对数组`arr`进行快速排序，并通过函数指针来比较元素的大小。

### 回调函数

回调函数在事件驱动编程、GUI 编程等场景中非常有用。

```c
void on_button_clicked(GtkButton *button, gpointer user_data) {
    g_print("Button clicked\n");
}

GtkWidget *button = gtk_button_new_with_label("Click me");
g_signal_connect(button, "clicked", G_CALLBACK(on_button_clicked), NULL);
```

上面的代码中定义了一个名为`on_button_clicked`的回调函数，它接受一个`GtkButton *`类型参数和一个`gpointer`类型参数，并在按钮被点击时输出一条消息。
然后我们使用 GTK+ 提供的函数`gtk_button_new_with_label`来创建一个带有标签的按钮，并使用`g_signal_connect`函数来连接按钮的`clicked`事件和回调函数。

## 示例

```c
#include <stdio.h>

int add(int a, int b) {
    return a + b;
}

int sub(int a, int b) {
    return a - b;
}

int mul(int a, int b) {
    return a * b;
}

int div(int a, int b) {
    return a / b;
}

int calculate(int a, int b, int (*p)(int, int)) {
    return p(a, b);
}

int main() {
    int a, b;
    char op;
    printf("Enter two numbers and an operator (+, -, *, /): ");
    scanf("%d %d %c", &a, &b, &op);
    int result;
    switch (op) {
        case '+':
            result = calculate(a, b, add);
            break;
        case '-':
            result = calculate(a, b, sub);
            break;
        case '*':
            result = calculate(a, b, mul);
            break;
        case '/':
            result = calculate(a, b, div);
            break;
        default:
            printf("Invalid operator\n");
            return 1;
    }
    printf("%d %c %d = %d\n", a, op, b, result);
    return 0;
}
```