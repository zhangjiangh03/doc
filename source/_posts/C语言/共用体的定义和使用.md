---
title: 共用体的定义和使用
date: 2022-09-25 10:19:00
categories:
- C语言
tags:
- C语言
---

共用体（union）是一种特殊的数据类型，和结构体类似，可以将不同的数据类型组合在一起，但是共用体中的每个成员占用的是相同的内存空间。
在任意时刻，共用体只能存储其中的一个成员，不同的成员之间共享同一块内存，并且占用的内存大小为所有成员中占用内存最大的那个。

## 共用体的定义

共用体的定义方式类似于结构体定义，使用关键字`union`并指定共用体的名称和各个成员。

```text
union 共用体名称 {
    成员类型 成员名称1;
    成员类型 成员名称2;
    ...
};
```

```c
union Color {
    unsigned int code;  // 颜色代码
    struct {
        unsigned char blue;
        unsigned char green;
        unsigned char red;
        unsigned char alpha;
    };
};
```

上面的代码定义了一个名为`Color`的共用体，它包含了一个无符号整型的颜色代码和四个无符号字符型的颜色通道。由于共用体中所有的成员占用的都是同一块内存（`&Color` = `&Color.code` =...），因此不同的成员之间不能同时存在。

## 共用体的使用

**引用**

- 共同体变量名.成员名
- 指针变量名->成员名
- (* 指针变量名).成员名

共用体中只能存在一个成员，需要显式地告诉编译器使用哪一个成员，这可以通过访问共用体的方式来实现。

```c
Color c = {.code = 0xFF0000FF};
printf("blue=%d, green=%d, red=%d, alpha=%d", c.blue, c.green, c.red, c.alpha);
```

上面的代码定义了一个名为`c`的`Color`类型的共用体，并初始化了它的颜色代码为`0xFF0000FF`。
然后，使用共用体中的四个颜色通道访问该颜色，
输出结果如下：

```c
blue=255, green=0, red=0, alpha=255
```

由于共用体中颜色代码和颜色通道占用的是同一块内存，因此修改其中一个成员会影响到其他的成员。

```c
c.red = 128;
printf("code=%X, blue=%d, green=%d, red=%d, alpha=%d", c.code, c.blue, c.green, c.red, c.alpha);
```

将共用体中颜色代码中的红色通道值修改为`128`，然后输出共用体中所有成员的值，输出结果如下：

```c
code=80FF00FF, blue=255, green=0, red=128, alpha=255
```

## 共用体的应用

共用体主要用于在不同的数据类型之间进行转换，可以在内存中创造出不同的视图，从而使程序更加灵活。
例如，可以使用共用体将无符号整型转换为浮点数，或者将浮点数转换为整型。

```c
union {
    unsigned int u;
    float f;
} uif;

uif.u = 0x3F800000;   // 1.0f 的 IEEE 754 标准单精度浮点数表示
printf("u=%X, f=%f\n", uif.u, uif.f);

uif.f = 2.0f;         // 浮点数 2.0f 对应的整型值
printf("u=%X, f=%f\n", uif.u, uif.f);
```

上面的代码定义了一个匿名的共用体，并在其中声明了一个无符号整型成员和一个浮点数成员，然后分别将它们的值设置为`0x3F800000`和`2.0f`。
由于共用体中所有的成员占用的都是同一块内存，因此可以通过访问不同的成员进行数据类型之间的转换。