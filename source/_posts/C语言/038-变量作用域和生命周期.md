---
title: 变量作用域和生命周期
date: 2022-12-25 13:45:00
categories:
- C语言
tags:
- C语言基础
---

变量作用域和生命周期是 C 和 C++ 语言中非常重要的两个概念，它们与程序的正确性、可维护性和性能密切相关。

## 概念

### 变量作用域

变量作用域是指变量的可见范围，也就是在哪些地方可以访问到该变量。
C/C++ 语言中有三种类型的变量作用域：

- 块作用域 (block scope)：在函数内部定义的变量为块作用域变量，其作用域从定义处开始直到块的末尾；
- 文件作用域 (file scope)：在函数外部定义的变量为文件作用域变量，其作用域从定义处开始直到文件的末尾；
- 函数原型作用域 (function prototype scope)：在函数原型中定义的形参为函数原型作用域变量，其作用域仅限于函数原型内部。

### 变量生命周期

变量生命周期是指变量存在的时间，也就是从何时开始到何时结束。
C/C++ 语言中有两种类型的变量生命周期：

- 静态生命周期 (static lifetime)：静态变量的生命周期从程序开始直到程序结束；
- 自动生命周期 (automatic lifetime)：自动变量的生命周期从变量定义处开始直到作用域结束。

## 作用

### 变量作用域

变量作用域的主要作用是控制变量的可见性，避免变量名冲突，提高程序的可读性和可维护性。

```c
int fib(int n) {
    if (n <= 1) {
        return n;
    }
    int a = 0, b = 1;
    for (int i = 2; i <= n; i++) {
        int c = a + b;
        a = b;
        b = c;
    }
    return b;
}
```

上面的代码实现了一个计算斐波那契数列的函数`fib`，它使用块作用域变量`a`、`b`和`c `来保存每一层递归的计算结果，并通过循环来计算斐波那契数列的各项值。

### 变量生命周期

变量生命周期的主要作用是控制内存的分配和释放，避免内存泄漏和内存溢出，提高程序的性能和稳定性。

```c
double sum(double a[], int n) {
    static double s;
    for (int i = 0; i < n; i++) {
        s += a[i];
    }
    return s;
}
```

上面的代码实现了一个计算数组元素和的函数`sum`，它使用静态变量`s`来保存上一次调用后的结果，并在本次调用时直接从该结果开始累加。

## 示例

下面的示例演示了如何使用变量作用域和生命周期实现一个简单的函数调用链。该程序定义了三个函数`f1`、`f2`和`f3`，并通过调用链的方式将它们连接起来。

```c
#include <stdio.h>

void f1(int n) {
    printf("f1: n = %d\n", n);
    f2(n + 1);
}

void f2(int n) {
    printf("f2: n = %d\n", n);
    f3(n * 2);
}

void f3(int n) {
    printf("f3: n = %d\n", n);
}

int main() {
    f1(3);
    return 0;
}
```

上面的代码定义了三个函数`f1`、`f2`和`f3`，它们分别输出传入参数的值，并通过函数调用链的方式将它们连接起来。
然后我们在`main`函数中调用`f1`函数，并传入参数`3`，最终输出函数调用链的结果。